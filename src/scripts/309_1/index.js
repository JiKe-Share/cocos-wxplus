window.__require=function t(e,o,n){function r(i,a){if(!o[i]){if(!e[i]){var s=i.split("/");if(s=s[s.length-1],!e[s]){var p="function"==typeof __require&&__require;if(!a&&p)return p(s,!0);if(c)return c(s,!0);throw new Error("Cannot find module '"+i+"'")}i=s}var l=o[i]={exports:{}};e[i][0].call(l.exports,function(t){return r(e[i][1][t]||t)},l,l.exports,t,e,o,n)}return o[i].exports}for(var c="function"==typeof __require&&__require,i=0;i<n.length;i++)r(n[i]);return r}({"309_1_LevelCtrl":[function(t,e,o){"use strict";cc._RF.push(e,"dd304OY2qdNzqTcFUU7FLat","309_1_LevelCtrl");var n,r=__extends,c=__decorate;Object.defineProperty(o,"__esModule",{value:!0});var i,a,s=t("Game"),p=t("AudioManager"),l=cc._decorator,u=l.ccclass,d=l.property;(i=n||(n={}))[i.none=0]="none",i[i.pat=1]="pat",i[i.take=2]="take",i[i.put=3]="put",i[i.table=4]="table";var f,m=function(){function t(){}return t.prototype.changeState=function(t,e){void 0===e&&(e=!0);var o=v.player,r=o.getChildByName("doge");(function(){if(t!==n.none)switch(o.state=t,o.stopAllActions(),t){case n.put:var e=cc.v3(r.getPosition());cc.tween(r).set({active:!0,position:e.add(cc.v3(0,40))}).to(.1,{position:e}).start();default:t!=n.put&&cc.tween(r).set({active:!(o.state===n.take)}).start();for(var c=0,i=o.children;c<i.length;c++){var a=i[c];"doge"!==a.name&&(a.active=parseInt(a.name)===o.state)}}})(),e&&p.default.playEffect(o.audio[o.state-1]),cc.tween(o).delay(.5).call(function(){if(o.state!=n.take&&o.state!=n.put){o.state=n.put,o.stopAllActions();for(var t=0,e=o.children;t<e.length;t++){var r=e[t];"doge"!==r.name&&(r.active=parseInt(r.name)===n.put)}}}).start()},t}();(function(t){t[t.running=0]="running",t[t.triggered=1]="triggered",t[t.expired=2]="expired",t[t.end=3]="end"})(a||(a={}));var g=function(){function t(){}return t.prototype.generateScore=function(t){return v.score.patData=t,null},t.prototype.playScore=function(t,e,o){return void 0===e&&(e=550),void 0===o&&(o=.25),new Promise(function(r){var c=v.score,i=c.patPool,s=c.patData,p=0;(function l(){var u=p<s.length?v.getPat(s[p],a.running):v.getPat(n.none,a.end);c.patShowed.push(u),u.parent=c;var d=c.convertToNodeSpaceAR(c.startWPoint),f=u.state!=a.end?c.convertToNodeSpaceAR(c.endWPoint):c.convertToNodeSpaceAR(c.endWPoint).add(cc.v3(0,e)),m=c.startWPoint.sub(c.endWPoint).mag()/e;cc.tween(u).set({position:d,scale:1,opacity:255}).parallel(cc.tween(u).delay(o).call(function(){++p<=s.length&&l()}),cc.tween(u).to(m,{position:f}).call(function(){u.state===a.running&&u.type!==n.none&&(u.state=a.expired,v.record.miss++,t(u)),u.type!=n.none&&v.record.total++,u.state===a.end&&r(),c.patShowed.splice(c.patShowed.indexOf(u),1),cc.tween(u).to(.5,{scale:1.2,opacity:0}).call(function(){i.put(u)}).start()})).start()})()})},t.prototype.bPatternVerified=function(t,e,o){void 0===o&&(o=60);for(var n=v.score,r=n.patShowed,c=n.patPoint,i=-1,s=0;s<r.length;s++)if(r[s].state===a.running){var p=r[s].parent.convertToNodeSpaceAR(c.convertToWorldSpaceAR(cc.v3(0,0,0))).sub(r[s].position).mag();if(r[s].type===t&&r[s].convertToWorldSpaceAR(cc.v3(0,0)).y<c.convertToWorldSpaceAR(cc.v3(0,0)).y&&p<=o){r[s].state=a.triggered,e(p,r[s]),i=s;break}}if(i>=0){var l=r.splice(i,1)[0];l.stopAllActions(),cc.tween(l).to(.1,{scale:1.2,opacity:0}).call(function(){l.state=a.triggered,n.patPool.put(l),v.record.true++,v.record.total++}).start()}},t.prototype.init=function(t,e){var o=v.score=t;o.patPoint=o.getChildByName("judge"),o.patShowed=[],o.patPrefab=e,o.startWPoint=o.getChildByName("start").convertToWorldSpaceAR(cc.v3(0,0,0)),o.endWPoint=o.getChildByName("end").convertToWorldSpaceAR(cc.v3(0,0,0)),o.patPool=new cc.NodePool},t}(),h=function(){function t(){}return t.prototype.changeMusic=function(t){var e=v.music;e.musicName=t,e.progress=0},t.prototype.playMusic=function(t){return new Promise(function(e){var o=v.music,n=0,r=t;p.default.playMusic(v.music.musicName,!1),o.getComponent(C).schedule(function(){n+=.1,v.music.progress=Math.floor(n/r*100+1)},.1),o.getComponent(C).scheduleOnce(function(){e(),p.default.stopMusic()},r)})},t}(),y=function(){function t(){}return t.prototype.init=function(){v.record.total=0,v.record.true=0,v.record.perfect=0,v.record.miss=0,v.record.combo=0,v.record.maxCombo=0,v.record.click=0},t}();(function(t){t[t.none=0]="none",t[t.perfect=1]="perfect",t[t.normal=2]="normal",t[t.miss=3]="miss",t[t.combo=4]="combo"})(f||(f={}));var _=function(){function t(){}return t.prototype.showTips=function(t,e){var o,n=t,r=n.pool,c=n.type,i=n.wPos,a=null!==(o=r.get())&&void 0!==o?o:cc.instantiate(n.prefab);a.opacity=255,a.scale=.8,a.parent=e,a.setPosition(e.convertToNodeSpaceAR(i)),a.children.forEach(function(t){t.active=parseInt(t.name)===c}),c===f.combo&&(a.getChildByName("4").getComponentInChildren(cc.Label).string=""+v.record.combo),cc.tween(a).to(.1,{scale:1}).delay(.5).to(.1,{opacity:0}).call(function(){r.put(a)}).start()},t}(),v=function(){function t(){}return Object.defineProperty(t,"player",{get:function(){return C.prototype._player},set:function(t){C.prototype._player=t},enumerable:!1,configurable:!0}),t.getPat=function(t,e){var o,n=null!==(o=this.score.patPool.get())&&void 0!==o?o:cc.instantiate(this.score.patPrefab);return n.type=t,n.state=e,n.children.forEach(function(e){e.active=parseInt(e.name)===t}),n},Object.defineProperty(t,"score",{get:function(){return C.prototype._score},set:function(t){C.prototype._score=t},enumerable:!1,configurable:!0}),Object.defineProperty(t,"music",{get:function(){return C.prototype._music},set:function(t){C.prototype._music=t},enumerable:!1,configurable:!0}),Object.defineProperty(t,"record",{get:function(){return C.prototype._record||(C.prototype._record={})},enumerable:!1,configurable:!0}),t}(),C=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.patPrefab=null,e.playerStateNode=null,e.patBar=null,e.tipsRange=null,e.tipsPrefab=null,e.resultNode=null,e.audioMap={pat:"lv309_1_1",take:"lv309_1_2",put:"lv309_1_3",desk:"lv309_1_4",miss:"lv309_1_5",bgm1:"lv309_1_6",bgm2:"lv309_1_7",bgm3:"lv309_1_8",bgm4:"lv309_1_9",bgm5:"lv309_1_10",bgm6:"lv309_1_11",bgm7:"lv309_1_12",bgm8:"lv309_1_13",success:"lv309_1_14",fail:"lv309_1_15"},e.perfectDistance=85,e.rightDistance=200,e._playerCtrl=new m,e._patCtrl=new g,e._musicCtrl=new h,e._recordCtrl=new y,e._tipsCtrl=new _,e._tipsCom=null,e.prefectTipsWPos=null,e.normalTipsWPos=null,e.comboTipsWPos=null,e.missTipsWPos=null,e._bgmScore=[[1,0,1,0,1,2,3],[1,2,3,0,1,2,3],[1,1,4,0,1,2,3],[1,1,4,4,1,2,3],[1,2,3,1,1,2,3],[1,1,2,0,3,3,3],[1,1,2,3,1,2,3],[1,4,2,3,4,2,3]],e._patDelay=.33,e._patSpeed=550,e._bgmPatDelay=[3.4,1,1,1,1,1,1,1],e._bgmEndTime=[4.32,2.184,2.328,2.328,2.16,2.304,2.208,2.376],e._curBgm=0,e}return r(e,t),e.prototype.onLoad=function(){v.music=this.node,v.player=this.playerStateNode,v.player.audio=[this.audioMap.pat,this.audioMap.take,this.audioMap.put,this.audioMap.desk],this._tipsCom={type:f.none,wPos:cc.v3(0,0),prefab:this.tipsPrefab,pool:new cc.NodePool},this.prefectTipsWPos=this.tipsRange.getChildByName("prefect").convertToWorldSpaceAR(cc.v3(0,0)),this.normalTipsWPos=this.tipsRange.getChildByName("normal").convertToWorldSpaceAR(cc.v3(0,0)),this.comboTipsWPos=this.tipsRange.getChildByName("combo").convertToWorldSpaceAR(cc.v3(0,0)),this.missTipsWPos=this.tipsRange.getChildByName("miss").convertToWorldSpaceAR(cc.v3(0,0)),this.resultNode.active=!1,this._recordCtrl.init(),this._patCtrl.init(this.patBar,this.patPrefab)},e.prototype.onEnable=function(){var t=this,e=function e(){var n;t._patCtrl.generateScore(t._bgmScore[t._curBgm]),t._musicCtrl.changeMusic(t.audioMap["bgm"+(t._curBgm+1)]),t._musicCtrl.playMusic(t._bgmEndTime[t._curBgm]),(n=t._bgmPatDelay[t._curBgm],new Promise(function(e){t.scheduleOnce(function(){e(t._patCtrl.playScore(function(){t.missPat()},t._patSpeed,t._patDelay))},n)})).then(function(){t._curBgm++,t._curBgm<t._bgmScore.length?e():o()})},o=function(){t.resultNode.opacity=0,t.resultNode.scale=0,t.resultNode.active=!0;var e=t.resultNode.getChildByName("completed"),o=t.resultNode.getChildByName("accuracy"),n=t.resultNode.getChildByName("prefect"),r=t.resultNode.getChildByName("combo"),c=t.resultNode.getChildByName("miss"),i=Math.floor(0===v.record.click?0:v.record.true/v.record.click*100),a=Math.floor(v.record.true/v.record.total*100);n.getComponentInChildren(cc.Label).string=""+v.record.perfect,e.getComponentInChildren(cc.Label).string=a+"%",r.getComponentInChildren(cc.Label).string=""+v.record.maxCombo,o.getComponentInChildren(cc.Label).string=i+"%",c.getComponentInChildren(cc.Label).string=""+v.record.miss,cc.tween(t.resultNode).to(.5,{scale:1},{easing:cc.easing.elasticIn}).to(.5,{opacity:255}).call(function(){var e;e=a>75,p.default.playEffect(e?t.audioMap.success:t.audioMap.fail),t.scheduleOnce(e?t.gameSucc:t.gameFail,2)}).start()};this._playerCtrl.changeState(n.take,!1),this.scheduleOnce(function(){var o;o=t.playerStateNode.getChildByName("doge"),t._playerCtrl.changeState(n.put,!1),cc.v3(o.getPosition()),t._playerCtrl.changeState(n.put),t.scheduleOnce(function(){e()},.5)},.5)},e.prototype.onDestroy=function(){this.unscheduleAllCallbacks(),p.default.stopMusic(),cc.audioEngine.stopAllEffects(),setTimeout(function(){p.default.playMusic(p.default.audioName.BACKGROUND)},0)},e.prototype.judgeClick=function(t){var e=this,o=t.target,n=parseInt(o.name);v.record.click++,this._playerCtrl.changeState(n),this._patCtrl.bPatternVerified(n,function(t,o){e.triggerSuccess(t,o)},this.rightDistance)},e.prototype.triggerSuccess=function(t){t<=this.perfectDistance?(this._tipsCom.type=f.perfect,this._tipsCom.wPos=this.prefectTipsWPos,this._tipsCtrl.showTips(this._tipsCom,this.tipsRange),v.record.perfect++):(this._tipsCom.type=f.normal,this._tipsCom.wPos=this.normalTipsWPos,this._tipsCtrl.showTips(this._tipsCom,this.tipsRange)),v.record.combo++,v.record.maxCombo=Math.max(v.record.maxCombo,v.record.combo),v.record.combo>3&&(this._tipsCom.type=f.combo,this._tipsCom.wPos=this.comboTipsWPos,this._tipsCtrl.showTips(this._tipsCom,this.tipsRange))},e.prototype.missPat=function(){v.record.combo=0,this._tipsCom.type=f.miss,this._tipsCom.wPos=this.missTipsWPos,this._tipsCtrl.showTips(this._tipsCom,this.tipsRange),p.default.playEffect(this.audioMap.miss)},e.prototype.gameSucc=function(){var t=this.node.getChildByName("ui").getChildByName("dd");this.scheduleOnce(function(){cc.find("Canvas/game").getComponent(s.default).showResultLayer()},1),cc.tween(t).delay(.2).to(.3,{opacity:255,scale:1.5}).delay(.75).call(function(){t.scale=0}).start()},e.prototype.gameFail=function(){var t=this.node.getChildByName("ui").getChildByName("xx");this.scheduleOnce(function(){cc.find("Canvas/game").getComponent(s.default).restartGame()},1.05),cc.tween(t).to(.3,{opacity:255,scale:1.5}).delay(.75).call(function(){t.scale=0}).start()},c([d({type:cc.Prefab})],e.prototype,"patPrefab",void 0),c([d({type:cc.Node})],e.prototype,"playerStateNode",void 0),c([d({type:cc.Node})],e.prototype,"patBar",void 0),c([d({type:cc.Node})],e.prototype,"tipsRange",void 0),c([d({type:cc.Prefab})],e.prototype,"tipsPrefab",void 0),c([d({type:cc.Node})],e.prototype,"resultNode",void 0),c([u],e)}(cc.Component);o.default=C,cc._RF.pop()},{AudioManager:void 0,Game:void 0}]},{},["309_1_LevelCtrl"]);